import sys
import os
import json
import numpy as np
import pandas as pd
from scipy.stats import pearsonr, spearmanr

# --- CONFIGURACI√ìN DE RUTAS ---
# Agregamos la carpeta 'src' al path para poder importar tus m√≥dulos
current_dir = os.path.dirname(os.path.abspath(__file__)) # Carpeta tests/
project_root = os.path.dirname(current_dir)             # Carpeta ra√≠z
src_path = os.path.join(project_root, "src")
sys.path.append(src_path)

# Importamos tus funciones de m√©tricas ya existentes
from metrics.fidelity import calculate_sbert_similarity, calculate_bertscore
from sentence_transformers import SentenceTransformer

def get_dataset():
    """
    Retorna 20 grupos de prueba con puntajes de or√°culo asignados (Similitud Sem√°ntica 0-1).
    Niveles: Alta (0.9-1.0), Media-Alta (0.7-0.8), Media-Baja (0.4-0.6), Baja/Nula (0.0-0.2)
    """
    return [
        {
            "id": 1, "topic": "COVID-19",
            "ref": "The hospital is overwhelmed with new patients, and the lack of medical supplies is compromising patient care.",
            "cands": [
                "Patient care is compromised due to the shortage of medical supplies and the hospital being overwhelmed.", # Alta
                "Hospitals are struggling with too many patients and not enough equipment.", # Media-Alta
                "Medical staff are tired because of the long shifts during the pandemic.", # Media-Baja (Relacionado, pero tangencial)
                "The weather in Italy is very nice this time of year." # Baja
            ],
            "oracle": [0.98, 0.75, 0.40, 0.01]
        },
        {
            "id": 2, "topic": "Econom√≠a",
            "ref": "Inflation has reached a 40-year high, causing the central bank to raise interest rates aggressively.",
            "cands": [
                "The central bank is raising interest rates aggressively because inflation hit a 40-year peak.", 
                "Prices are rising fast, so the bank is making it more expensive to borrow money.",
                "The stock market is volatile due to uncertainty in global markets.",
                "Basketball is a popular sport in the United States."
            ],
            "oracle": [0.97, 0.80, 0.30, 0.00]
        },
        {
            "id": 3, "topic": "Tecnolog√≠a",
            "ref": "Artificial Intelligence is transforming industries by automating repetitive tasks and providing data-driven insights.",
            "cands": [
                "AI is changing industries through the automation of routine tasks and offering insights based on data.",
                "Computers are getting smarter and helping businesses work faster.",
                "Python is a great programming language for data science.",
                "My grandmother bakes the best apple pie."
            ],
            "oracle": [0.95, 0.50, 0.35, 0.00]
        },
        {
            "id": 4, "topic": "Clima",
            "ref": "Rising sea levels threaten coastal communities, forcing governments to invest in flood defense infrastructure.",
            "cands": [
                "Governments are investing in flood defenses because rising seas endanger coastal areas.",
                "The ocean is getting higher, so cities need to build walls to stop the water.",
                "Marine biology is the study of life in the oceans.",
                "I forgot to bring my umbrella today."
            ],
            "oracle": [0.96, 0.75, 0.25, 0.05]
        },
        {
            "id": 5, "topic": "Trabajo Remoto",
            "ref": "Remote work offers flexibility but can lead to feelings of isolation and difficulty in separating professional and personal life.",
            "cands": [
                "Working from home is flexible, yet it may cause isolation and blur work-life boundaries.",
                "It's nice to work in pajamas, but sometimes you feel lonely.",
                "Office buildings are becoming less popular in downtown areas.",
                "The traffic jam this morning was terrible."
            ],
            "oracle": [0.94, 0.65, 0.30, 0.02]
        },
        {
            "id": 6, "topic": "Nutrici√≥n",
            "ref": "A balanced diet rich in fruits, vegetables, and whole grains is essential for maintaining long-term health.",
            "cands": [
                "Eating whole grains, fruits, and vegetables is key to keeping good health for the long run.",
                "You should eat salads and apples to stay healthy.",
                "Cooking at home is often cheaper than eating at restaurants.",
                "Fast cars are exciting to drive."
            ],
            "oracle": [0.93, 0.60, 0.20, 0.00]
        },
        {
            "id": 7, "topic": "Astronom√≠a",
            "ref": " The James Webb Telescope has captured the deepest and sharpest infrared image of the distant universe to date.",
            "cands": [
                "The deepest infrared image of the universe so far was taken by the James Webb Telescope.",
                "New telescopes are letting us see stars that are very far away.",
                "Mars is known as the Red Planet.",
                "I need to buy new glasses to see better."
            ],
            "oracle": [0.98, 0.70, 0.25, 0.01]
        },
        {
            "id": 8, "topic": "Deportes",
            "ref": "Regular exercise improves cardiovascular health and boosts mental well-being by releasing endorphins.",
            "cands": [
                "Cardiovascular health and mental well-being are boosted by exercise, which releases endorphins.",
                "Running makes your heart strong and makes you feel happy.",
                "Professional athletes earn a lot of money.",
                "The internet connection is very slow today."
            ],
            "oracle": [0.95, 0.75, 0.20, 0.00]
        },
        {
            "id": 9, "topic": "Educaci√≥n",
            "ref": "Online learning platforms have democratized access to education, allowing students from all over the world to learn new skills.",
            "cands": [
                "Students globally can learn skills thanks to online platforms that have democratized education.",
                "You can learn anything on the internet if you have a computer.",
                "Universities are expensive and hard to get into.",
                "Cats are very independent pets."
            ],
            "oracle": [0.92, 0.65, 0.30, 0.00]
        },
        {
            "id": 10, "topic": "Historia",
            "ref": "The Industrial Revolution marked a major turning point in history, shifting from agrarian societies to industrial and urban ones.",
            "cands": [
                "History changed when society shifted from farming to industry during the Industrial Revolution.",
                "Factories were built and people moved to cities a long time ago.",
                "Steam engines were invented in the 18th century.",
                "I like reading science fiction novels."
            ],
            "oracle": [0.90, 0.60, 0.40, 0.05]
        },
        {
            "id": 11, "topic": "Energ√≠a",
            "ref": "Transitioning to renewable energy sources like solar and wind is critical to mitigating the effects of global warming.",
            "cands": [
                "To stop global warming, we must switch to renewables such as wind and solar power.",
                "Using sun and wind for power helps the planet stay cool.",
                "Electric cars are becoming more affordable.",
                "Coffee helps me wake up in the morning."
            ],
            "oracle": [0.94, 0.65, 0.35, 0.00]
        },
        {
            "id": 12, "topic": "Ciberseguridad",
            "ref": "Phishing attacks are becoming more sophisticated, requiring employees to be vigilant about checking email sources.",
            "cands": [
                "Employees must check email sources carefully as phishing attacks get more advanced.",
                "Be careful with fake emails that try to steal your password.",
                "Antivirus software should be updated regularly.",
                "The river flows into the sea."
            ],
            "oracle": [0.91, 0.70, 0.40, 0.00]
        },
        {
            "id": 13, "topic": "Literatura",
            "ref": "Shakespeare's works explore universal themes of love, power, and betrayal that resonate with audiences centuries later.",
            "cands": [
                "Themes of power, betrayal, and love in Shakespeare's plays still affect audiences today.",
                "Old plays are still famous because they talk about human feelings.",
                "Writing a novel requires a lot of patience and dedication.",
                "Calculus is a difficult branch of mathematics."
            ],
            "oracle": [0.89, 0.60, 0.20, 0.00]
        },
        {
            "id": 14, "topic": "Psicolog√≠a",
            "ref": "Cognitive behavioral therapy is an effective treatment for anxiety, helping patients identify and change negative thought patterns.",
            "cands": [
                "Anxiety can be treated with CBT, which helps change negative thinking patterns.",
                "Talking to a therapist helps you stop worrying so much.",
                "The brain is divided into two hemispheres.",
                "Blue is my favorite color."
            ],
            "oracle": [0.92, 0.65, 0.30, 0.00]
        },
        {
            "id": 15, "topic": "Viajes",
            "ref": "Sustainable tourism aims to minimize the environmental impact of travel while supporting local economies.",
            "cands": [
                "Supporting local economies and reducing environmental harm are goals of sustainable tourism.",
                "Eco-friendly travel is about not destroying nature when you visit places.",
                "Airplanes emit a lot of carbon dioxide.",
                "Pizza is originally from Italy."
            ],
            "oracle": [0.93, 0.70, 0.35, 0.05]
        },
        {
            "id": 16, "topic": "Marketing",
            "ref": "Social media marketing allows brands to engage directly with their audience and build brand loyalty.",
            "cands": [
                "Brands build loyalty and engage audiences directly through social media marketing.",
                "Companies use Instagram to talk to customers and sell things.",
                "Traditional TV commercials are expensive.",
                "It is raining outside right now."
            ],
            "oracle": [0.95, 0.65, 0.25, 0.00]
        },
        {
            "id": 17, "topic": "Biolog√≠a",
            "ref": "Photosynthesis is the process by which green plants use sunlight to synthesize nutrients from carbon dioxide and water.",
            "cands": [
                "Green plants synthesize nutrients from water and CO2 using sunlight in a process called photosynthesis.",
                "Plants make their own food using the light from the sun.",
                "Animals breathe in oxygen and breathe out carbon dioxide.",
                "I bought a new laptop yesterday."
            ],
            "oracle": [0.96, 0.70, 0.30, 0.00]
        },
        {
            "id": 18, "topic": "Finanzas",
            "ref": "Diversifying your investment portfolio reduces risk by spreading assets across different categories.",
            "cands": [
                "Risk is reduced by spreading assets into various categories to diversify your portfolio.",
                "Don't put all your money in one stock; buy different things.",
                "Bitcoin is a volatile cryptocurrency.",
                "Birds migrate south for the winter."
            ],
            "oracle": [0.94, 0.70, 0.30, 0.00]
        },
        {
            "id": 19, "topic": "M√∫sica",
            "ref": "Jazz is characterized by swing and blue notes, call and response vocals, polyrhythms and improvisation.",
            "cands": [
                "Improvisation, polyrhythms, and swing notes are key characteristics of Jazz music.",
                "Jazz is a type of music where musicians make up the tune as they play.",
                "Playing the guitar hurts my fingers.",
                "The soup is too hot to eat."
            ],
            "oracle": [0.90, 0.65, 0.15, 0.00]
        },
        {
            "id": 20, "topic": "Pol√≠tica",
            "ref": "Democracy is a system of government by the whole population or all the eligible members of a state, typically through elected representatives.",
            "cands": [
                "A system where the population elects representatives to govern is called democracy.",
                "People voting for their leaders is what makes a country free.",
                "Laws are made to keep order in society.",
                "My phone battery is low."
            ],
            "oracle": [0.92, 0.65, 0.30, 0.00]
        }
    ]

def run_full_validation():
    print("--- üöÄ VALIDACI√ìN MASIVA DE CALIDAD (SBERT vs BERTScore) ---")
    print("Objetivo: Demostrar que SBERT tiene alta correlaci√≥n con el juicio humano.")
    
    # 1. Cargar modelo SBERT (Solo una vez)
    print("Cargando modelo SBERT en memoria...")
    sbert_model = SentenceTransformer('all-MiniLM-L6-v2')
    
    dataset = get_dataset()
    
    # Si olvidaste pegar los datos, avisamos
    if not dataset:
        print("‚ö†Ô∏è  ALERTA: El dataset est√° vac√≠o. Aseg√∫rate de pegar la lista en get_dataset().")
        return

    results = []
    all_oracle = []
    all_sbert = []
    all_bert = []

    print(f"Procesando {len(dataset)} grupos tem√°ticos...")
    
    # --- 2. BUCLE DE PROCESAMIENTO ---
    for i, group in enumerate(dataset):
        topic = group.get('topic', f'Grupo {i+1}')
        print(f"[{i+1}/{len(dataset)}] Evaluando: {topic}...", end="\r")
        
        ref = group['ref']
        cands = group['cands']      # Puede llamarse 'candidates' o 'cands' seg√∫n como lo pegues
        if 'cands' not in group: cands = group['candidates'] # Fallback por si acaso
            
        oracle_scores = group['oracle']
        
        # A) Calcular SBERT (Vectorizado = R√°pido)
        ref_emb = sbert_model.encode([ref], convert_to_tensor=True)
        cand_embs = sbert_model.encode(cands, convert_to_tensor=True)
        sbert_scores = calculate_sbert_similarity(cand_embs, ref_emb)
        
        # B) Calcular BERTScore (Iterativo = Lento)
        # Usamos tu funci√≥n wrapper que ya maneja los detalles
        bert_scores = calculate_bertscore(cands, [ref]*len(cands), model_type="bert-base-uncased")
        
        # C) Guardar Resultados
        for idx, cand in enumerate(cands):
            row = {
                "Topic": topic,
                "Candidate": cand,
                "Oracle": oracle_scores[idx],
                "SBERT": float(sbert_scores[idx]),
                "BERTScore": float(bert_scores[idx])
            }
            results.append(row)
            
            # Acumuladores para la correlaci√≥n final
            all_oracle.append(row["Oracle"])
            all_sbert.append(row["SBERT"])
            all_bert.append(row["BERTScore"])

    print("\n‚úÖ C√°lculo completado.")

    # --- 3. AN√ÅLISIS ESTAD√çSTICO ---
    np_oracle = np.array(all_oracle)
    np_sbert = np.array(all_sbert)
    np_bert = np.array(all_bert)

    # Correlaci√≥n Pearson (Linealidad - ¬øEl valor absoluto se parece?)
    pearson_sbert, _ = pearsonr(np_oracle, np_sbert)
    pearson_bert, _ = pearsonr(np_oracle, np_bert)
    
    # Correlaci√≥n Spearman (Ranking - ¬øEl orden de mejor a peor es correcto?)
    # Esta es vital para Algoritmos Gen√©ticos que se basan en ranking.
    spearman_sbert, _ = spearmanr(np_oracle, np_sbert)
    spearman_bert, _ = spearmanr(np_oracle, np_bert)

    print("\n" + "="*50)
    print(f"RESULTADOS FINALES (N={len(all_oracle)} pares)")
    print("="*50)
    
    print(f"PEARSON (Precisi√≥n del valor):")
    print(f"  SBERT:     {pearson_sbert:.4f}")
    print(f"  BERTScore: {pearson_bert:.4f}")
    
    print(f"\nSPEARMAN (Calidad del ordenamiento):")
    print(f"  SBERT:     {spearman_sbert:.4f}")
    print(f"  BERTScore: {spearman_bert:.4f}")
    print("-" * 50)

    # Validaci√≥n autom√°tica para tu tesis
    diff = pearson_sbert - pearson_bert
    print("\n--- CONCLUSI√ìN ---")
    if diff > -0.05:
        print("‚úÖ √âXITO: SBERT es estad√≠sticamente equivalente (o superior) a BERTScore.")
        print("   Justificaci√≥n: La p√©rdida de calidad es nula o despreciable,")
        print("   mientras que la ganancia en velocidad es >36x.")
    else:
        print("‚ö†Ô∏è NOTA: SBERT tiene una correlaci√≥n menor. Revisa si el trade-off vale la pena.")

    # Guardar JSON detallado para gr√°ficas posteriores
    out_file = "validation_results_20groups.json"
    with open(out_file, "w", encoding="utf-8") as f:
        json.dump(results, f, indent=2, ensure_ascii=False)
    print(f"üíæ Datos crudos guardados en '{out_file}'")

if __name__ == "__main__":
    run_full_validation()